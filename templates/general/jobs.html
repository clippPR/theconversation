{% extends '../base.html' %}

{% block body_class %}jobs{% end %}
{% block title %}Jobs | {% end %}

{% block content %}

  <div id="main" role="main">
    <h2 class="mobile-page-headline section-heading">Jobs</h2>
    <div class="jobs-container">

      <!--
      <header>  
        <ul class="stats">
          <li>
            <span class="stat">796</span>
            <span class="label">jobs</span>
          </li>
          <li>
            <span class="stat">36</span>
            <span class="label">companies</span>
          </li>
          <li>
            <span class="stat">53</span>
            <span class="label">cities</span>
          </li>
        </ul>
        <div class="job-search">
          <form id="jobform" method="GET" action="http://www.indeed.com/jobs">
            <div class="form-row">
              <input type="text" name="q" value="" size="25" id="q" placeholder="Job Title or Keywords">
            </div>
            <div class="form-row">
              <input type="text" name="l" value="" size="" id="l" placeholder="City, State or Zip">
            </div>
            <div class="form-button">
              <input type="submit" value="Search" name="">
            </div>
          </form>
        </div>
      </header>
      -->

      <div id="jobs-content" class="row">
        <div class="col-sm-3">
          <div class="job-tabs-container">
            <h2>Filter</h2>
            <ul class="job-tabs filter-tabs">
              <li><a href="#category" usv:filter="category">By Job Category</a></li>
              <li><a href="#location" usv:filter="location">By Location</a></li>
              <li><a href="#company" usv:filter="company">By Company</a></li>
              <!--<li><a href="#title" usv:filter="title">By Title</a></li>-->
            </ul>
          </div>

          <div id="jobs-menu" class="filter-menu" style="display:none;">
            <div usv:filter="category">
              <h2>Categories</h2>

              <ul class="side-nav filter-tabs" id="category">
                {% for c in categories %}
                  <li><a id="{{ slugify(c) }}" href="#{{ slugify(c) }}">{{ c }}</a></li>
                {% end %}
              </ul>
            </div>

            <div usv:filter="location">
              <h2>Location</h2>
              <ul class="side-nav filter-tabs" id="location">
                {% for l in locations %}
                  <li><a id="{{ slugify(l) }}" href="#{{ slugify(l) }}">{{ l }}</a></li>
                {% end %}
              </ul>
            </div>

            <div usv:filter="company">
              <h2>Company</h2>
              <ul class="side-nav filter-tabs" id="company">
                {% for c in companies %}
                  <li><a id="{{ slugify(c) }}" href="#{{ slugify(c) }}">{{ c }}</a></li>
                {% end %}
              </ul>
            </div>

              <!--
              <ul class="side-nav" id="title">
                <li><a href="#title,c-level">C-Level</a></li>
                <li><a href="#title,director">Director</a></li>
                <li><a href="#title,internships">Internships</a></li>
                <li><a href="#title,vice-president">Vice President</a></li>
              </ul>
              -->
          </div><!--jobs-menu-->
        </div><!--col-sm-3-->
      
      
        <div class="col-sm-9">
          <!-- Heading -->
          <h2 class="subsection section-heading" id="jobs-heading" style="clear:both; border-bottom:none">Jobs <span class="filter-label" style="display:none"></span></h2> 
            <div class="jobs" style="border-bottom:none">
              <!--Column headers -->
              <div>
                <div class="col-sm-3">
                  <div class="btn-group">
                    <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                      Company 
                      <span class="caret"></span>
                    </button>
                    <ul class="dropdown-menu" role="menu" usv:filter="company">
                      {% for c in companies %}
                        <li><a id="{{ slugify(c) }}" href="#{{ slugify(c) }}">{{ c }}</a></li>
                      {% end %}
                      <li><a href="#">Action</a></li>
                    </ul>
                  </div>
                </div>
                <div class="col-sm-3">Location</div>
                <div class="col-sm-6">Job Title</div>
              </div>

              <!-- Jobs rows -->
              {% for j in jobs %}
              <div class="job" usv:company-slug="{{ slugify(j['company']) }}" usv:company="{{ j['company'] }}" usv:location="{{ j['formattedLocation'] }}" usv:location-slug="{{ slugify(j['formattedLocation']) }}" usv:category="{{ j['position'] }}" usv:category-slug="{{ slugify(j['position']) }}">
                <div class="col-sm-3">{{ j['company'] }}</div>
                <div class="col-sm-3">{{ j['formattedLocation'] }}</div>
                <div class="col-sm-6"><a href="{{ j['url'] }}">{{ j['jobtitle'] }}</a></div>
              </div>
              {% end %}
            </div>
        </div><!--col-sm-9-->

      </div>
    </div>
  </div>
{% end %} <!-- end block content -->


{% block javascript %}

<script>
  
  $(document).ready(function() {
    
    //If URL has a hash, do relevant filtering on page load
    if (window.location.hash) {
      parse_hash();
      var entire_query = window.location.hash.split("#")[1];
      var filter_type = entire_query.split("=")[0]
      var query = entire_query.split("=")[1]
      filter_menu(filter_type);
      filter_jobs(filter_type, query);
    }

    // Filters jobs every time a change is made to the hash
    $(window).on('hashchange', function() {
      console.log('hash changed');
      parse_hash();
    });
    

    // For clicking on filter options, ex. By Job Category
    $(".job-tabs a").click(function(e) {
      e.preventDefault();
      var query = $(this).attr("usv:filter");
      filter_menu(query);
    });

    // Clicking on a specific filter link, ex. Administrative
    /*$(".side-nav a").click(function(e) {
      e.preventDefault();
      var filter_type = $(this).parent().parent().parent().attr("usv:filter");
      //var query = $(this).text();
      var query = this.href.split("#")[1];
      window.location.hash = filter_type + "=" + query;
      filter_jobs(filter_type, query);
    });
    */
    

    // Clicking on a specific filter link, ex. Administrative
    // FOR NEW BRITTANY DROPDOWNS
    $(".dropdown-menu a").click(function(e) {
      e.preventDefault();
      var filter_type = $(this).parent().parent().attr("usv:filter");
      console.log(filter_type);
      var query = this.href.split("#")[1];
      add_hash(filter_type, query)
      //location.hash = filter_type + "=" + query;
      //filter_jobs(filter_type, query);
    });

  }); //$(document).ready();

  // Adds a query to the hash
  function add_hash(filter_type, query) {
    hash_array = parse_hash();

    // See if filter_type already in hash_array
    filter_type_flag = false;
    for (var i=0; i<hash_array.length; i++) {
      if hash_array[i][0] == filter_type {
        filter_type_flag = true; // filter_type already exists
        
        // For this filter_type, see if query already exists
        query_flag = false;
        for (var j=0; j<hash_array[i].length; j++) {
          if hash_array[i][j] == query {
            query_flag = true; // Query already exists
            hash_array[i].splice(j,1); //Remove query from the hash
          }
        }
        // Adds query if it didn't already exist
        if (query_flag == false){
          hash_array[i].push(query);
        } 
      }
    }

    // Adds filter_type and query if filter_type didn't already exist
    if (filter_type_flag == false) {
        hash_array.push([filter_type, query]);
    }

    // Reset the window's hash
    console.log(hash_array);
    set_hash(hash_array);
  }


  // Parses the hash into an array of arrays
  // Ex: [[company, duolingo], [location, NYC, SF]]
  function parse_hash() {
    var entire_query = window.location.hash.split("#")[1];
    var filter_types = entire_query.split("&");

    // Iterate over all filter types
    return_array = [];
    for (var i=0; i<filter_types.length; i++) {
      filter_array = []; 
      filter_type = filter_types[i] // ie. company, category or location
      filter_array.push(filter_type.split("=")[0]); //adds filter_type as first element in subarray

      // Split out all the queries for each filter_type
      queries = filter_type.split("=")[1];
      queries = queries.split(",");

      //Iterate over all these queries
      for (var j=0; j<queries.length; j++) {
        query = queries[j];
        filter_array.push(query);
      }

      //Add filter_array to return_array
      return_array.push(filter_array);
    }
    return return_array;
  }

  // Sets the hash
  function set_hash(hash_array) {

  }


  // Shows and hides jobs based on filtering
  function filter_jobs(filter_type, query) {
    if (filter_type == "all" && query == "all") {
      $('.job').each(function(){
        $(this).show();
        $("#jobs-heading .filter-label").hide()
        $('.side-nav li').removeClass('active');
      });
      return
    }
    $('.job').each(function(){
      if ($(this).attr("usv:" + filter_type + "-slug") == query) {
        $(this).show();
      } else {
        $(this).hide();
      }
    });
    
    // light off all wrong buttons
    $('.side-nav li').removeClass('active');

    // light up the right button
    $("#" + query).parent().addClass("active");
    
    // set the filter heading
    var nice_label = $("#" + query).text();
    $("#jobs-heading .filter-label").text('matching "' + nice_label + '"').show();
    
  } // filter_jobs

  // Shows and hides left hand menu filter links
  function filter_menu(filter_type) {
    $("#jobs-menu").show();
    $('.job-tabs li').removeClass('active');

     $('.job-tabs a').each(function(){
       if ($(this).attr("usv:filter") == filter_type) {
         $(this).parent().addClass('active')
       }
     });

    $('.filter-menu div').each(function(){
      if ($(this).attr("usv:filter") == filter_type) {
        $(this).show();
      } else {
        $(this).hide();
      }
    
    filter_jobs("all", "all");
    
    });
  } // filter_menu

  </script>
{% end %}
