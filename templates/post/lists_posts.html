{% extends '../base.html' %}

{% block body_class %}conversation{% end %}

{% block precontent %}
  <div class="tools tools-mobile visible-xs">
    <b>Welcome!</b>
    &nbsp;
    <a href="/posts/welcome-to-the-new-usvcom#comment-1066691905">Posting guidelines</a>
    |
    <a href="https://play.google.com/store/apps/details?id=com.connectedio.usvmobile" target="_blank">Android app</a>
  </div>
{% end %}

{% block content %}

  <div id="main" role="main">  
  
    <div class="row">
      <div class="col-sm-4">
        <div class="deck">
          
        </div>
        <div class="sidebar-widget">
          <h3>Welcome to the conversation</h3>
          <p><a class="btn btn-primary" role="button" data-toggle="modal" href="#submit-modal">Submit a post</a></p>
          <p style="font-size: .9em;"><a href="/posts/welcome-to-the-new-usvcom#comment-1066691905">posting guidelines</a> <span class="text-muted">|</span> <a id="show-tools-btn" href="#tools">tools</a></p>
        </div>
        
        {% if 'tags' in globals() and len(tags) > 0 %}
        <div class="sidebar-widget">
         <h3 style="">Popular tags (last 14 days):</h3>
         <ul class="filter-tabs tags">
           {% for t in tags['result'] %}
               <li><a data-tag-count="{{t['count']}}" href="/tagged/{{t['_id']}}">#{{t['_id']}} ({{t['count']}})</a></li>
           {% end %}
         </ul>
         </div>
         {% end %}
         <div class="sidebar-widget">
           <h3>Featured:</h3>
           <ul class="feed">
             {% for i, p in enumerate(featured_posts) %}
               <li class="post featured">
                 {% include featured_post_snippet.html %}
               </li>
             {% end %}
           </ul> 
          </div>
      </div><!-- /.col-sm-6 -->
      <div class="col-sm-8">
        {% if msg == "success" and new_post %}
          <div class="alert alert-success" style="color: #333">
            <p style="margin-top:0"><strong>Thanks!</strong> Your post has been published. Here's the link: </p>  
            <p><a href="/posts/{{ new_post['slug'] }}">http://usv.com/posts/{{ new_post['slug'] }}</a></p>
            <p>
              <a href="https://twitter.com/share" class="twitter-share-button" data-url="/posts/{{ new_post['slug'] }}" data-text="{{ new_post['title'] }}" data-via="usvcommunity" data-size="large" data-count="none">Tweet</a>
              <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
            </p>
          </div>
        {% end %}
        
        {% include daily_posts_list_snippet.html %}
        
      </div><!-- /.col-sm-6 -->
    </div><!-- /.row -->
  </div>
{% end %}

{% block javascript %}
  <script type="text/javascript">
    $(document).ready(function() {
      if (window.location.hash == "#tools") {
        $("#tools").modal('show');
      }
      $('#show-tools-btn').click(function(e) {
        $("#tools").modal('show');
      });
      $('#bookmarklet').click(function(e) {
        e.preventDefault();
        alert('This is a bookmarklet.  First drag it to your bookmarks bar, then you can use it to share web pages to USV.com.');
      })
      fp_max_height = 0;
      $('.featured-post').each(function() {
        if ($(this).height() > fp_max_height) {
          fp_max_height = $(this).height();
        }
      })
      if ($('.featured-post:visible').length == 2) {
        /* only do this on ipad where we're showing two at the top */
        $('.featured-post').height(fp_max_height);
      }
      {% if current_user %}
        $('#submit-modal .submit').show();
        {% if current_user in settings.get('staff') %}
          $('#submit-modal .login').hide();
          $('#submit-modal .submit-staff').show();
          $('a.mute').click(function(e) {
            e.preventDefault();
            if (confirm("are you sure?")) {
              window.location = this.href;
            }
          })
        {% else %}
          $('#submit-modal .login').show();
        {% end %}
      {% end %}
      
      /* Tag weighting */
      /*
      function compare(a,b){
        return a-b;
      }
      var counts = []
      $("ul.tags a").each(function() {
        var count = parseInt($(this).attr('data-tag-count'));
        counts.push(count)
      });
      counts.sort(compare);
      low = counts[0];
      high = counts[counts.length-1];
      var scores = {}
      for (var i = 0; i < counts.length; i++) {
        score = (counts[i] * 1 / high + 1) * 100;
        scores[i] = score;
      }
      $("ul.tags a").each(function() {
        var count = parseInt($(this).attr('data-tag-count'));
        
      });
      */
      
      $('body').on('click', '.more .btn', function(e){
        link = $(this);
        e.preventDefault();
        day_str = $(this).attr('data-day');
        var d = new Date(day_str);
        data = {
          'day': d.toUTCString()
        }
        link.html('<img src="/static/img/ajax-loader.gif" />');
        $.ajax('/api/posts/get_day', {
          'data':data,
          'complete': function(response) {
              obj = $.parseJSON(response.responseText);
              html = obj.data.html;
              link.parent().after(html);
              link.remove();
            }
        });
      });
      
    }); 
  </script>
{% end %}
